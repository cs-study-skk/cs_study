# 👉저장 프로시저(SP, Stored Procedure)란?
DB 내부에 저장된 **일련의 SQL 명령문들을 하나의 함수처럼 실행하기 위한 쿼리의 집합.** <br>

- SQL Server에서 제공되는 프로그래밍 기능. 쿼리문의 집합
- 어떠한 동작을 여러 쿼리에 걸쳐 일괄 처리하기 위한 용도로 사용.
- 자주 사용되는 일반적인 쿼리를 모듈화시켜서 필요할 때마다 호출
- 테이블처럼 각 데이터베이스 내부에 저장


## 일반 쿼리문 vs 저장프로시저
### 👉일반 쿼리문 작동 방식
![image](https://github.com/user-attachments/assets/b34bf264-3f91-4ae8-b405-fe3047e12556)
<br/>
1) **구문분석** : 구문의 오류 파악
2) **개체 이름 확인** : 사용하는 개체(ex.테이블, 컬럼)가 데이터베이스에 존재하는지 확인 
3) **생성권한 확인** : 현재 사용자가 저장 프로시저를 생성할 권한이 있는지 확인
4) **최적화** : 해당 쿼리문이가장 좋은 성능을 낼 수 있는 경로를 확인(인덱스 및 테이블 스캔 등)
5) **컴파일 및 실행계획 등록** : 최적화 된 결과를 바탕으로 실행 계획 결과를 메모리(캐시)에 등록    

### 👉저장 프로시저 작동 방식
### 1. 저장 프로시저 정의 단계
![image](https://github.com/user-attachments/assets/75b411e6-32ba-4f74-a798-0611df5eaf63)
<br/>
1) **구문분석** : 구문의 오류 파악
2) **지연된 이름 확인** : 저장 프로시저를 정의하는 시점에 해당 개체(ex. 테이블, 컬럼)가 존재하지 않아도 상관없다.<br/>
-> 해당 테이블의 존재여부는 프로시저 실행 시점에 확인
3) **생성권한 확인** : 현재 사용자가 저장 프로시저를 생성할 권한이 있는지 확인
4) **시스템 테이블 등록** : 저장 프로시저의 이름 및 코드가 시스템 테이블에 등록

### 2. 처음으로 저장 프로시저를 실행
![image](https://github.com/user-attachments/assets/7761d9ad-41e7-49cd-9078-90fd66a8588a)
<br/>
일반적인 쿼리문 수행단계와 유사하다. <br/>
정의단계에서 구문분석은 끝났기 때문에 구문분석은 진행하지 않는다.<br/>
저장프로시저 정의 단계의 지연된 이름확인에서 미루어두었던 해당 개체 존재 유무를 개체 이름 확인을 통해 수행한다.

### 3. 이후의 저장 프로시저 실행
![image](https://github.com/user-attachments/assets/3a12754e-03e5-4e2d-93ac-ece952bda80f)
<br/>
이후에 두번째 실행 부터는 메모리(캐시)에 있는 것을 그대로 가져와 재사용하게 되어 수행시간을 많이 단축한다.



## 저장프로시저의 장.단점
### 장점
- **SQL Server의 성능을 향상 시킬 수 있다.** <br/>
여러개의 쿼리를 한번에 실행할 수 있다.<br/>
두번째 실행부터는 캐시(메모리)에 있는 것을 가져와서 사용하므로 속도가 빨라진다. <br/>

- **유지보수 및 재활용 측면에서 좋다.** <br/>
응용프로그램에서 직접 SQL문을 호출하지 않고 저장 프로시저의 이름을 호출하도록 설정하여 사용하는 경우가 많아, 수정요건이 발생할때 코드 내 SQL문을 건드리는게 아닌 SP 파일만 수정하면 되기 때문에 유지보수에 유리하다.<br/>
한번 저장 프로시저를 생성해 놓으면, 언제든 실행이 가능하기 때문에 재활용 측면에서 매우 좋다.<br/>

- **보안을 강화할 수 있다** <br/>
저장 프로시저는 사용자별로 테이블에 권한을 주지 않고, 저장 프로시저에만 접근 권한을 줌으로써 테이블의 모든 정보를 사용자에게 노출하지 않고 프로시저에서 선택한 정보만 사용자에게 보여줄 수 있다.<br/>

- **네트워크의 부하(전송량)를 줄일 수 있다.** <br/>
클라이언트에서 서버로 쿼리의 모든 텍스트가 전송될 경우 네트워크에는 큰 부하가 발생하게 된다.<br/>
하지만 저장 프로시저를 이용한다면 저장 프로시저의 이름, 매개변수 등 몇글자만 전송하면 되기 때문에 부하를 크게 줄일 수 있다.<br/>


### 단점
- **DB 확장 어려움** <br/>
서버의 수를 늘려야할 때, DB의 수를 늘리는 것이 더 어렵다.<br/>
DB 교체는 거의 불가능하다.<br/>

- **데이터 분석의 어려움** <br/>
개발된 프로시저가 여러 곳에서 사용 될 경우 수정했을 때 영향의 분석이 어렵다(별도의 Description 사용).<br/>
배포, 버전 관리 등에 대한 이력 관리가 힘들다.<br/>
APP에서 SP를 호출하여 사용하는 경우 문제가 생겨도 해당 이슈에 대한 추적이 힘들다(별도의 에러 테이블 사용).<br/>

- **낮은 처리 성능** <br/>
문자, 숫자열 연산에 SP를 사용하면 오히려 c, java보다 느린 성능을 보일 수 있다<br/>




## Reference
https://velog.io/@sweet_sumin/%EC%A0%80%EC%9E%A5-%ED%94%84%EB%A1%9C%EC%8B%9C%EC%A0%80-Stored-Procedure
https://devkingdom.tistory.com/323
https://eunsun-zizone-zzang.tistory.com/52
